## netperf and iperf3 tests

### With SPDM vs Without SPDM

The benchmarking scripts have to be run twice: one time to assess performance with SPDM enabled, and a second time to get baseline results without SPDM.

Currently, enabling/disabling SPDM requires restoring the original files in QEMU and the original kernel driver (and recompiling both software).

### benchmarking scripts

#### netbenchmark.sh:

This script runs the benchmarks saving the output as `[command]_[date]_[protocol]_[send|receive].out`, in which date is in the format YYYYmmDDHHMM

Variables at the top of the script define some parameters. Double check those.

Make sure iperf3 and netperf servers are running at the host

```iperf3 -s -J -i 0 --udp-counters-64bit```

```netserv```

#### parse_netbenchmark.py

Processes netbenchmark.sh output into csv files

Usage: `python3 parse_netbenchmark.py YYYYmmDDHHMM`, where YYYYmmDDHHMM is the timestamp generated by `netbenchmark.sh`

The output file is named `netbenchmark_YYYYmmDDHHMM_summary.csv`

### Plotting results with plot_netbenchmark.py

Plots graphs from csv files generated by parse_netbenchmark.py

Usage: `python3 plot_netbenchmark.py csv_file1 label1 csv_file2 label2 ...`, where the label represents the label to be displayed in the graph's legend

Typical usage is `python3 plot_netbenchmark.py netbenchmark_202201301000_summary.csv "With SPDM" netbenchmark_202201311100_summary.csv "No SPDM`


## nginx file download test

* Setting up nginx:

- On ubuntu the files are located at `/var/www/html` by default
- On buildroot the files are located at `/usr/html`

* Compile dowload_test.c
```
CC=<path to buildroot output>/host/bin/x86_64-buildroot-linux-uclibc-gcc gcc dowload_test.c -o dowload_test_guest
gcc dowload_test.c -o dowload_test_host
```

### Download from host to guest

* Copy `download_test_guest` to the VM and run `download_test_guest [target:port] [input file] [iterations]`

* `[target:port]` is the host's IP address and default port is 80

* `[input file]` is a text file containing the list of files that will be downloaded (they should be at available at the host's nginx)

* `[iterations]` the number of times each file will be downloaded

* For each file in the file list, a file `[filename]`, a file `[filename].time` will be generated, containing the time it took to download the file, one number per line representing an iteration

### Download from guest to host

* Run `download_test_host [target:port] [input file] [iterations]`

* `[target:port]` is the guest's IP address and the port is the one configured at QEMU command line

* `[input file]` is a text file containing the list of files that will be downloaded (they should be at available at the guests's nginx)

* `[iterations]` the number of times each file will be downloaded

* For each file in the file list, a file `[filename]`, a file `[filename].time` will be generated, containing the time it took to download the file, one number per line representing an iteration